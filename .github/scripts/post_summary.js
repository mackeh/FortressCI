const fs = require("fs");

module.exports = async ({ github, context }) => {
  const sarifFiles = [
    "semgrep.sarif",
    "trivy-results.sarif",
    "checkov.sarif",
    "bicep.sarif",
    "snyk.sarif",
  ];
  let checkRows = [];
  let failCount = 0;

  for (const file of sarifFiles) {
    if (fs.existsSync(file)) {
      try {
        const data = fs.readFileSync(file, "utf8");
        const sarif = JSON.parse(data);
        const runs = sarif.runs || [];
        let count = 0;
        runs.forEach((run) => {
          count += (run.results || []).length;
        });

        const status = count > 0 ? "âŒ Failed" : "âœ… Passed";
        checkRows.push(
          `| ${file.replace(".sarif", "")} | ${status} | ${count} issues |`,
        );
        if (count > 0) failCount++;
      } catch (e) {
        checkRows.push(`| ${file} | âš ï¸ Error | Could not parse |`);
      }
    } else {
      checkRows.push(`| ${file} | âšª Skipped | N/A |`);
    }
  }

  const overallStatus =
    failCount > 0 ? "âŒ Security Checks Failed" : "âœ… Security Checks Passed";

  const body = `
  ## ğŸ›¡ï¸ FortressCI Security Summary
  
  **Status**: ${overallStatus}
  
  | Scanner | Status | Findings |
  | :--- | :--- | :--- |
  ${checkRows.join("\n")}
  
  ---
  
  Generated by [FortressCI](https://github.com/mackeh/FortressCI) ğŸ°
  `;

  // Post comment
  if (context.issue.number) {
    await github.rest.issues.createComment({
      owner: context.repo.owner,
      repo: context.repo.repo,
      issue_number: context.issue.number,
      body: body,
    });
  }
};
